import React, { useState } from 'react';
import type { Project } from '../types';

// Sub-component for rendering details list to cleaner code
const DetailList: React.FC<{ details: Project['details'] }> = ({ details }) => {
  if (!details || details.length === 0) return null;

  return (
    <ul className="list-disc list-inside space-y-2 text-gray-600 dark:text-gray-400 pl-2">
      {details.map((detail, index) => {
        if (typeof detail === 'string') {
          return <li key={index}>{detail}</li>;
        }
        return (
          <li key={index} className="list-none mt-4 mb-2">
            <span className="font-bold text-gray-800 dark:text-gray-200 block mb-2">
              {detail.title}
            </span>
            <ul className="list-disc list-inside space-y-1 pl-4 border-l-2 border-yellow-200 dark:border-yellow-900 ml-1">
              {detail.items.map((subItem, subIndex) => (
                <li key={subIndex}>{subItem}</li>
              ))}
            </ul>
          </li>
        );
      })}
    </ul>
  );
};

// Sub-component for rendering images
const DetailGallery: React.FC<{ images: Project['detailImages']; title: string }> = ({ images, title }) => {
  if (!images || images.length === 0) return null;

  return (
    <div className="mt-8 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-4 gap-y-8">
      {images.map((imgItem, index) => (
        <div key={index} className="flex flex-col space-y-3 group/image">
          <div className="relative aspect-video rounded-lg border border-gray-200/10 bg-gray-800 overflow-hidden shadow-sm group-hover/image:shadow-md transition-shadow">
            <img
              src={imgItem.url}
              alt={imgItem.caption || `${title} detail image ${index + 1}`}
              loading="lazy"
              decoding="async"
              referrerPolicy="no-referrer"
              className="absolute inset-0 w-full h-full object-cover"
            />
          </div>
          <p className="text-sm text-gray-600 dark:text-gray-400 text-center font-medium px-1">
            {imgItem.caption}
          </p>
        </div>
      ))}
    </div>
  );
};

interface ProjectCardProps {
  project: Project;
}

const ProjectCard: React.FC<ProjectCardProps> = ({ project }) => {
  const { title, description, tags, thumbnailImage, details, context, detailImages } = project;
  const [isExpanded, setIsExpanded] = useState(false);

  return (
    <div className="group relative grid gap-4 pb-1 transition-all sm:grid-cols-8 sm:gap-8 md:gap-4 lg:hover:!opacity-100 lg:group-hover/list:opacity-50">
      {/* Hover Background Effect */}
      <div className="absolute -inset-x-4 -inset-y-4 z-0 hidden rounded-lg transition motion-reduce:transition-none md:block group-hover:bg-gray-100/80 group-hover:shadow-[inset_0_1px_0_0_rgba(148,163,184,0.1)] group-hover:drop-shadow-lg dark:group-hover:bg-neutral-800/50 dark:group-hover:shadow-[inset_0_1px_0_0_rgba(148,163,184,0.1)] dark:group-hover:drop-shadow-lg"></div>
      
      {/* Thumbnail Section */}
      {thumbnailImage && (
        <div className="z-10 sm:order-1 sm:col-span-2 sm:mt-1">
          <div className="relative aspect-video w-full rounded-lg border-2 border-gray-200/10 transition group-hover:border-gray-200/30 sm:mx-0 bg-gray-800 overflow-hidden shadow-sm">
             <img 
               src={thumbnailImage} 
               alt={`${title} project thumbnail`} 
               loading="lazy" 
               decoding="async" 
               className="absolute inset-0 w-full h-full object-cover" 
             />
          </div>
        </div>
      )}

      {/* Content Section */}
      <div className="z-10 sm:order-2 sm:col-span-6">
        {context && (
          <div className="text-xs font-semibold uppercase tracking-wide text-gray-500 mb-2">
            {context}
          </div>
        )}
        <h3 className="text-xl font-bold text-gray-900 dark:text-white mb-2">{title}</h3>
        <p className="text-gray-600 dark:text-gray-400 mb-4">{description}</p>
        
        {/* Tags */}
        <div className="flex flex-wrap gap-2 mb-4">
          {tags.map((tag) => (
            <span key={tag} className="bg-yellow-100 text-yellow-800 dark:bg-yellow-900/40 dark:text-yellow-200 text-xs font-semibold px-2.5 py-1 rounded-full border border-yellow-200 dark:border-yellow-800">
              {tag}
            </span>
          ))}
        </div>

        {/* Expandable Details */}
        {details && details.length > 0 && (
          <div>
            <button 
              onClick={() => setIsExpanded(!isExpanded)} 
              className="inline-flex items-center space-x-2 text-sm font-semibold text-yellow-600 dark:text-[#FEE500] hover:underline focus:outline-none"
              aria-expanded={isExpanded}
            >
              <span>{isExpanded ? '간략히 보기' : '자세히 보기'}</span>
              <svg xmlns="http://www.w3.org/2000/svg" className={`h-4 w-4 transition-transform duration-300 ${isExpanded ? 'rotate-180' : ''}`} fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>
            </button>
            <div 
              className={`transition-all duration-500 ease-in-out overflow-hidden ${isExpanded ? 'max-h-[3000px] opacity-100 mt-4' : 'max-h-0 opacity-0'}`}
            >
              <DetailList details={details} />
              <DetailGallery images={detailImages} title={title} />
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default ProjectCard;